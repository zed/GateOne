

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>terminal &mdash; Gate One v0.9 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Gate One v0.9 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for terminal</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c">#       Copyright 2011 Liftoff Software Corporation</span>
<span class="c">#</span>

<span class="c"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.9&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="n">__doc__</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">About This Module</span>
<span class="s">=================</span>
<span class="s">This crux of this module is the Terminal class which is a pure-Python</span>
<span class="s">implementation of a quintessential Unix-style terminal emulator.  It actually</span>
<span class="s">does its best to emulate an xterm.  This means it supports the majority of the</span>
<span class="s">relevant portions of ECMA-48.  This includes support for emulating varous VT-*</span>
<span class="s">terminal types as well as the &quot;linux&quot; terminal type.</span>

<span class="s">The Terminal class&#39;s emulation support is not complete but it should suffice for</span>
<span class="s">most terminal emulation needs.  If additional support for certain escape</span>
<span class="s">sequences or modes are required please feel free to provide a patch or to simply</span>
<span class="s">ask for something to be added.</span>

<span class="s">Note that Terminal was written from scratch in order to be as fast as possible.</span>
<span class="s">Comments have been placed where different implementations/development patterns</span>
<span class="s">have been tried and ultimately failed to provide speed improvements.  Any and</span>
<span class="s">all suggestions or patches to improve speed (or emulation support) are welcome!</span>

<span class="s">Supported Emulation Types</span>
<span class="s">-------------------------</span>
<span class="s">Without any special mode settings or parameters, Terminal should be able to</span>
<span class="s">support most applications under the following terminal types (e.g.</span>
<span class="s">&quot;export TERM=&lt;terminal type&gt;&quot;):</span>

<span class="s"> * xterm (the most important one)</span>
<span class="s"> * ECMA-48/ANSI X3.64</span>
<span class="s"> * Nearly all the VT-* types:  VT-52, VT-100, VT-220, VT-320, VT-420, and VT-520</span>
<span class="s"> * Linux console (&quot;linux&quot;)</span>

<span class="s">What Terminal Doesn&#39;t Do</span>
<span class="s">------------------------</span>
<span class="s">The Terminal class is meant to emulate the display portion of a given terminal.</span>
<span class="s">It does not translate keystrokes into escape sequences or special control</span>
<span class="s">codes--you&#39;ll have to take care of that in your application (or at the</span>
<span class="s">client-side like Gate One).  It does, however, keep track of many</span>
<span class="s">keystroke-specific modes of operation such as Application Cursor Keys and the G0</span>
<span class="s">and G1 charset modes *with* callbacks that can be used to notify your</span>
<span class="s">application when something changes.</span>

<span class="s">Special Considerations</span>
<span class="s">----------------------</span>
<span class="s">Many methods inside Terminal start with an underscore.  This was done to</span>
<span class="s">indicate that such methods shouldn&#39;t be called directly (from a program that</span>
<span class="s">imported the module).  If it was thought that a situation might arise where a</span>
<span class="s">method could be used externally by a controlling program, the underscore was</span>
<span class="s">omitted.</span>

<span class="s">Asynchronous Use</span>
<span class="s">----------------</span>
<span class="s">To support asynchronous usage (and make everything faster), Terminal was written</span>
<span class="s">to support extensive callbacks that are called when certain events are</span>
<span class="s">encountered.  Here are the events and their callbacks:</span>

<span class="s">============================    ========================================================================</span>
<span class="s">Callback                        Called when...</span>
<span class="s">============================    ========================================================================</span>
<span class="s">Terminal.CALLBACK_SCROLL_UP     The terminal is scrolled up (back).</span>
<span class="s">Terminal.CALLBACK_CHANGED       The screen is changed/updated.</span>
<span class="s">Terminal.CALLBACK_CURSOR_POS    The cursor position changes.</span>
<span class="s">Terminal.CALLBACK_DSR           A Device Status Report (DSR) is requested (via the DSR escape sequence).</span>
<span class="s">Terminal.CALLBACK_TITLE         The terminal title changes (xterm-style)</span>
<span class="s">Terminal.CALLBACK_BELL          The bell character (^G) is encountered.</span>
<span class="s">Terminal.CALLBACK_OPT           The special optional escape sequence is encountered.</span>
<span class="s">Terminal.CALLBACK_MODE          The terminal mode setting changes (e.g. use alternate screen buffer).</span>
<span class="s">============================    ========================================================================</span>

<span class="s">Note that Terminal.CALLBACK_DSR is special in that it in most cases it will be called with arguments.  See the code for examples of how and when this happens.</span>

<span class="s">Also, in most cases it is unwise to override Terminal.CALLBACK_MODE since this method is primarily meant for internal use within the Terminal class.</span>

<span class="s">Using Terminal</span>
<span class="s">--------------</span>
<span class="s">Gate One makes extensive use of the Terminal class and its callbacks.  So that&#39;s</span>
<span class="s">a great place to look for specific examples (gateone.py and termio.py,</span>
<span class="s">specifically).  Having said that, implementing Terminal is pretty</span>
<span class="s">straightforward::</span>

<span class="s">    &gt;&gt;&gt; import terminal</span>
<span class="s">    &gt;&gt;&gt; term = terminal.Terminal(24, 80)</span>
<span class="s">    &gt;&gt;&gt; term.write(&quot;This text will be written to the terminal screen.&quot;)</span>
<span class="s">    &gt;&gt;&gt; term.dump()</span>
<span class="s">    [u&#39;This text will be written to the terminal screen.                               &#39;,</span>
<span class="s">    &lt;snip&gt;</span>
<span class="s">    u&#39;                                                                                &#39;]</span>

<span class="s">Here&#39;s an example with some basic callbacks:</span>

<span class="s">    &gt;&gt;&gt; def mycallback():</span>
<span class="s">    ...     &quot;This will be called whenever the screen changes.&quot;</span>
<span class="s">    ...     print(&quot;Screen update! Perfect time to dump the terminal screen.&quot;)</span>
<span class="s">    ...     print(term.dump()[0]) # Only need to see the top line for this demo =)</span>
<span class="s">    ...     print(&quot;Just dumped the screen.&quot;)</span>
<span class="s">    &gt;&gt;&gt; import terminal</span>
<span class="s">    &gt;&gt;&gt; term = terminal.Terminal(24, 80)</span>
<span class="s">    &gt;&gt;&gt; term.callbacks[term.CALLBACK_CHANGED] = mycallback</span>
<span class="s">    &gt;&gt;&gt; term.write(&quot;This should result in mycallback() being called&quot;)</span>
<span class="s">    Screen update! Perfect time to dump the terminal screen.</span>
<span class="s">    This should result in mycallback() being called</span>
<span class="s">    Just dumped the screen.</span>

<span class="s">.. note:: In testing Gate One it was determined that it is faster to perform the conversion of a terminal screen to HTML on the server side than it is on the client side (via JavaScript anyway).</span>

<span class="s">About The Scrollback Bufffer</span>
<span class="s">----------------------------</span>
<span class="s">The Terminal class implements a scrollback buffer.  Here&#39;s how it works:</span>
<span class="s">Whenever a scroll_up() event occurs, the line (or lines) that will be removed</span>
<span class="s">from the top of the screen will be placed into Terminal.scrollback_buf.  Then,</span>
<span class="s">whenever dump_html() is called, the scrollback buffer will be returned along</span>
<span class="s">with the screen output and reset to an empty state.</span>

<span class="s">Why do this?  In the event that a very large write() occurs (e.g. &#39;ps aux&#39;), it</span>
<span class="s">gives the controlling program the ability to capture what went past the screen</span>
<span class="s">without some fancy tracking logic surrounding Terminal.write().</span>

<span class="s">More information about how this works can be had by looking at the dump_html()</span>
<span class="s">function itself.</span>

<span class="s">.. note:: There&#39;s more than one function that empties Terminal.scrollback_buf when called.  You&#39;ll just have to have a look around =)</span>

<span class="s">Class Docstrings</span>
<span class="s">================</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="c"># Imports</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">imap</span><span class="p">,</span> <span class="n">izip</span><span class="p">,</span> <span class="n">count</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c"># Globals</span>
<span class="c"># These are for HTML output:</span>
<span class="n">RENDITION_CLASSES</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;reset&#39;</span><span class="p">,</span> <span class="c"># Special: Return everything to defaults</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;bold&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;dim&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;italic&#39;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;underline&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;blink&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;fastblink&#39;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;reverse&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;hidden&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s">&#39;strikethrough&#39;</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s">&#39;resetfont&#39;</span><span class="p">,</span> <span class="c"># NOTE: The font renditions don&#39;t do anything right now</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s">&#39;font11&#39;</span><span class="p">,</span> <span class="c"># Mostly because I have no idea what they are supposed to look</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s">&#39;font12&#39;</span><span class="p">,</span> <span class="c"># like.</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s">&#39;font13&#39;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s">&#39;font14&#39;</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s">&#39;font15&#39;</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s">&#39;font16&#39;</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s">&#39;font17&#39;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s">&#39;font18&#39;</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s">&#39;font19&#39;</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s">&#39;fraktur&#39;</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">:</span> <span class="s">&#39;boldreset&#39;</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s">&#39;dimreset&#39;</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s">&#39;italicreset&#39;</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s">&#39;underlinereset&#39;</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">:</span> <span class="s">&#39;reversereset&#39;</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">:</span> <span class="s">&#39;hiddenreset&#39;</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">:</span> <span class="s">&#39;strikethroughreset&#39;</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">:</span> <span class="s">&#39;f0&#39;</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">:</span> <span class="s">&#39;f1&#39;</span><span class="p">,</span>
    <span class="mi">32</span><span class="p">:</span> <span class="s">&#39;f2&#39;</span><span class="p">,</span>
    <span class="mi">33</span><span class="p">:</span> <span class="s">&#39;f3&#39;</span><span class="p">,</span>
    <span class="mi">34</span><span class="p">:</span> <span class="s">&#39;f4&#39;</span><span class="p">,</span>
    <span class="mi">35</span><span class="p">:</span> <span class="s">&#39;f5&#39;</span><span class="p">,</span>
    <span class="mi">36</span><span class="p">:</span> <span class="s">&#39;f6&#39;</span><span class="p">,</span>
    <span class="mi">37</span><span class="p">:</span> <span class="s">&#39;f7&#39;</span><span class="p">,</span>
    <span class="mi">39</span><span class="p">:</span> <span class="s">&#39;foregroundreset&#39;</span><span class="p">,</span> <span class="c"># Special: Set FG to default</span>
    <span class="mi">40</span><span class="p">:</span> <span class="s">&#39;b0&#39;</span><span class="p">,</span>
    <span class="mi">41</span><span class="p">:</span> <span class="s">&#39;b1&#39;</span><span class="p">,</span>
    <span class="mi">42</span><span class="p">:</span> <span class="s">&#39;b2&#39;</span><span class="p">,</span>
    <span class="mi">43</span><span class="p">:</span> <span class="s">&#39;b3&#39;</span><span class="p">,</span>
    <span class="mi">44</span><span class="p">:</span> <span class="s">&#39;b4&#39;</span><span class="p">,</span>
    <span class="mi">45</span><span class="p">:</span> <span class="s">&#39;b5&#39;</span><span class="p">,</span>
    <span class="mi">46</span><span class="p">:</span> <span class="s">&#39;b6&#39;</span><span class="p">,</span>
    <span class="mi">47</span><span class="p">:</span> <span class="s">&#39;b7&#39;</span><span class="p">,</span>
    <span class="mi">49</span><span class="p">:</span> <span class="s">&#39;backgroundreset&#39;</span><span class="p">,</span> <span class="c"># Special: Set BG to default</span>
    <span class="mi">51</span><span class="p">:</span> <span class="s">&#39;frame&#39;</span><span class="p">,</span>
    <span class="mi">52</span><span class="p">:</span> <span class="s">&#39;encircle&#39;</span><span class="p">,</span>
    <span class="mi">53</span><span class="p">:</span> <span class="s">&#39;overline&#39;</span><span class="p">,</span>
    <span class="mi">60</span><span class="p">:</span> <span class="s">&#39;rightline&#39;</span><span class="p">,</span>
    <span class="mi">61</span><span class="p">:</span> <span class="s">&#39;rightdoubleline&#39;</span><span class="p">,</span>
    <span class="mi">62</span><span class="p">:</span> <span class="s">&#39;leftline&#39;</span><span class="p">,</span>
    <span class="mi">63</span><span class="p">:</span> <span class="s">&#39;leftdoubleline&#39;</span>
<span class="p">})</span>

<span class="c"># TODO List:</span>
<span class="c">#</span>
<span class="c">#   * Needs tests!</span>
<span class="c">#   * Figure out how to handle programs like htop that position the cursor without following up with proper rendition reset sequences.</span>

<span class="k">class</span> <span class="nc">Terminal</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminal controller class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ASCII_NUL</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c"># Null</span>
    <span class="n">ASCII_BEL</span> <span class="o">=</span> <span class="mi">7</span>     <span class="c"># Bell (BEL)</span>
    <span class="n">ASCII_BS</span> <span class="o">=</span> <span class="mi">8</span>      <span class="c"># Backspace</span>
    <span class="n">ASCII_HT</span> <span class="o">=</span> <span class="mi">9</span>      <span class="c"># Horizontal Tab</span>
    <span class="n">ASCII_LF</span> <span class="o">=</span> <span class="mi">10</span>     <span class="c"># Line Feed</span>
    <span class="n">ASCII_VT</span> <span class="o">=</span> <span class="mi">11</span>     <span class="c"># Vertical Tab</span>
    <span class="n">ASCII_FF</span> <span class="o">=</span> <span class="mi">12</span>     <span class="c"># Form Feed</span>
    <span class="n">ASCII_CR</span> <span class="o">=</span> <span class="mi">13</span>     <span class="c"># Carriage Return</span>
    <span class="n">ASCII_XON</span> <span class="o">=</span> <span class="mi">17</span>    <span class="c"># Resume Transmission</span>
    <span class="n">ASCII_XOFF</span> <span class="o">=</span> <span class="mi">19</span>   <span class="c"># Stop Transmission or Ignore Characters</span>
    <span class="n">ASCII_CAN</span> <span class="o">=</span> <span class="mi">24</span>    <span class="c"># Cancel Escape Sequence</span>
    <span class="n">ASCII_SUB</span> <span class="o">=</span> <span class="mi">26</span>    <span class="c"># Substitute: Cancel Escape Sequence and replace with ?</span>
    <span class="n">ASCII_ESC</span> <span class="o">=</span> <span class="mi">27</span>    <span class="c"># Escape</span>
    <span class="n">ASCII_CSI</span> <span class="o">=</span> <span class="mi">155</span>   <span class="c"># Control Sequence Introducer (that nothing uses)</span>
    <span class="n">ASCII_HTS</span> <span class="o">=</span> <span class="mi">210</span>   <span class="c"># Horizontal Tab Stop (HTS)</span>

    <span class="n">charsets</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;0&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c"># Line drawing mode</span>
            <span class="mi">95</span><span class="p">:</span> <span class="s">u&#39; &#39;</span><span class="p">,</span>
            <span class="mi">96</span><span class="p">:</span> <span class="s">u&#39;◆&#39;</span><span class="p">,</span>
            <span class="mi">97</span><span class="p">:</span> <span class="s">u&#39;▒&#39;</span><span class="p">,</span>
            <span class="mi">98</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">99</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\x0c</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">100</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">101</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">102</span><span class="p">:</span> <span class="s">u&#39;°&#39;</span><span class="p">,</span>
            <span class="mi">103</span><span class="p">:</span> <span class="s">u&#39;±&#39;</span><span class="p">,</span>
            <span class="mi">104</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">105</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\x0b</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">106</span><span class="p">:</span> <span class="s">u&#39;┘&#39;</span><span class="p">,</span>
            <span class="mi">107</span><span class="p">:</span> <span class="s">u&#39;┐&#39;</span><span class="p">,</span>
            <span class="mi">108</span><span class="p">:</span> <span class="s">u&#39;┌&#39;</span><span class="p">,</span>
            <span class="mi">109</span><span class="p">:</span> <span class="s">u&#39;└&#39;</span><span class="p">,</span>
            <span class="mi">110</span><span class="p">:</span> <span class="s">u&#39;┼&#39;</span><span class="p">,</span>
            <span class="mi">111</span><span class="p">:</span> <span class="s">u&#39;⎺&#39;</span><span class="p">,</span> <span class="c"># All these bars and not a drink!</span>
            <span class="mi">112</span><span class="p">:</span> <span class="s">u&#39;⎻&#39;</span><span class="p">,</span>
            <span class="mi">113</span><span class="p">:</span> <span class="s">u&#39;─&#39;</span><span class="p">,</span>
            <span class="mi">114</span><span class="p">:</span> <span class="s">u&#39;⎼&#39;</span><span class="p">,</span>
            <span class="mi">115</span><span class="p">:</span> <span class="s">u&#39;⎽&#39;</span><span class="p">,</span>
            <span class="mi">116</span><span class="p">:</span> <span class="s">u&#39;├&#39;</span><span class="p">,</span>
            <span class="mi">117</span><span class="p">:</span> <span class="s">u&#39;┤&#39;</span><span class="p">,</span>
            <span class="mi">118</span><span class="p">:</span> <span class="s">u&#39;┴&#39;</span><span class="p">,</span>
            <span class="mi">119</span><span class="p">:</span> <span class="s">u&#39;┬&#39;</span><span class="p">,</span>
            <span class="mi">120</span><span class="p">:</span> <span class="s">u&#39;│&#39;</span><span class="p">,</span>
            <span class="mi">121</span><span class="p">:</span> <span class="s">u&#39;≤&#39;</span><span class="p">,</span>
            <span class="mi">122</span><span class="p">:</span> <span class="s">u&#39;≥&#39;</span><span class="p">,</span>
            <span class="mi">123</span><span class="p">:</span> <span class="s">u&#39;π&#39;</span><span class="p">,</span>
            <span class="mi">124</span><span class="p">:</span> <span class="s">u&#39;≠&#39;</span><span class="p">,</span>
            <span class="mi">125</span><span class="p">:</span> <span class="s">u&#39;£&#39;</span><span class="p">,</span>
            <span class="mi">126</span><span class="p">:</span> <span class="s">u&#39;·&#39;</span> <span class="c"># Centered dot--who comes up with this stuff?!?</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">CALLBACK_SCROLL_UP</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c"># Called after a scroll up event (new line)</span>
    <span class="n">CALLBACK_CHANGED</span> <span class="o">=</span> <span class="mi">2</span>      <span class="c"># Called after the screen is updated</span>
    <span class="n">CALLBACK_CURSOR_POS</span> <span class="o">=</span> <span class="mi">3</span>   <span class="c"># Called after the cursor position is updated</span>
    <span class="c"># &lt;waives hand in air&gt; You are not concerned with the number 4</span>
    <span class="n">CALLBACK_DSR</span> <span class="o">=</span> <span class="mi">5</span>          <span class="c"># Called when a DSR requires a response</span>
    <span class="c"># NOTE: CALLBACK_DSR must accept &#39;response&#39; as either the first argument or</span>
    <span class="c">#       as a keyword argument.</span>
    <span class="n">CALLBACK_TITLE</span> <span class="o">=</span> <span class="mi">6</span>        <span class="c"># Called when the terminal sets the window title</span>
    <span class="n">CALLBACK_BELL</span> <span class="o">=</span> <span class="mi">7</span>         <span class="c"># Called after ASCII_BEL is encountered.</span>
    <span class="n">CALLBACK_OPT</span> <span class="o">=</span> <span class="mi">8</span>   <span class="c"># Called when we encounter the optional ESC sequence</span>
    <span class="c"># NOTE: CALLBACK_OPT must accept &#39;chars&#39; as either the first argument or as</span>
    <span class="c">#       a keyword argument.</span>
    <span class="n">CALLBACK_MODE</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c"># Called when the terminal mode changes (e.g. DECCKM)</span>

    <span class="n">RE_CSI_ESC_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1B\[([?A-Za-z0-9;@:\!]*)([A-Za-z@_])&#39;</span><span class="p">)</span>
    <span class="n">RE_ESC_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1b(.*\x1b</span><span class="se">\\</span><span class="s">|[ABCDEFGHIJKLMNOQRSTUVWXYZa-z0-9=]|[()# %*+].)&#39;</span><span class="p">)</span>
    <span class="n">RE_TITLE_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1b\][0-2]\;(.*)(\x07|\x1b</span><span class="se">\\</span><span class="s">)&#39;</span><span class="p">)</span>
    <span class="c"># The below regex is used to match our optional (non-standard) handler</span>
    <span class="n">RE_OPT_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1b\]_\;(.*)(\x07|\x1b</span><span class="se">\\</span><span class="s">)&#39;</span><span class="p">)</span>
    <span class="n">RE_NUMBERS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;\d*&#39;</span><span class="p">)</span> <span class="c"># Matches any number</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Gate One&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># For holding escape sequences as they&#39;re typed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># Special: So we can differentiate between</span>
                                  <span class="c"># certain circumstances.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_screen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_renditions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G1_charset</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span>
        <span class="c"># Set the default window margins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_NUL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_BEL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bell</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_BS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backspace</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_HT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_horizontal_tab</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_LF</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linefeed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_VT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linefeed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_FF</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linefeed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_CR</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_XON</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xon</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_CAN</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_esc_sequence</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_XOFF</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xoff</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_ESC</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_esc_sequence</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_ESC</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_CSI</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_rendition</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c"># TODO: Finish these:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># TODO: Make a different set of these for each respective emulation mode (VT-52, VT-100, VT-200, etc etc)</span>
            <span class="s">&#39;#&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_line_params</span><span class="p">,</span> <span class="c"># Varies</span>
            <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_terminator</span><span class="p">,</span> <span class="c"># ST</span>
            <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">,</span> <span class="c"># Reset terminal</span>
            <span class="s">&#39;D&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Move/scroll window up one line    IND</span>
            <span class="s">&#39;M&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_linefeed</span><span class="p">,</span> <span class="c"># Move/scroll window down one line RI</span>
            <span class="s">&#39;E&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_line</span><span class="p">,</span> <span class="c"># Move to next line NEL</span>
            <span class="s">&#39;F&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enter Graphics Mode</span>
            <span class="s">&#39;G&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_line</span><span class="p">,</span> <span class="c"># Exit Graphics Mode</span>
            <span class="s">&#39;6&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsr_get_cursor_position</span><span class="p">,</span> <span class="c"># Get cursor position   DSR</span>
            <span class="s">&#39;7&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_cursor_position</span><span class="p">,</span> <span class="c"># Save cursor position and attributes   DECSC</span>
            <span class="s">&#39;8&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_cursor_position</span><span class="p">,</span> <span class="c"># Restore cursor position and attributes   DECSC</span>
            <span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_tabstop</span><span class="p">,</span> <span class="c"># Set a tab at the current column   HTS</span>
            <span class="s">&#39;I&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_linefeed</span><span class="p">,</span>
            <span class="s">&#39;(&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_G0_charset</span><span class="p">,</span> <span class="c"># Designate G0 Character Set</span>
            <span class="s">&#39;)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_G1_charset</span><span class="p">,</span> <span class="c"># Designate G1 Character Set</span>
            <span class="s">&#39;N&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set single shift 2    SS2</span>
            <span class="s">&#39;O&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set single shift 3    SS3</span>
            <span class="s">&#39;5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_status_report</span><span class="p">,</span> <span class="c"># Request: Device status report DSR</span>
            <span class="s">&#39;0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Response: terminal is OK  DSR</span>
            <span class="s">&#39;P&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcs_handler</span><span class="p">,</span> <span class="c"># Device Control String  DCS</span>
            <span class="s">&#39;=&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Application Keypad  DECPAM</span>
            <span class="s">&#39;&gt;&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Exit alternate keypad mode</span>
            <span class="s">&#39;&lt;&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Exit VT-52 mode</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csi_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_up</span><span class="p">,</span>
            <span class="s">&#39;B&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_down</span><span class="p">,</span>
            <span class="s">&#39;C&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_right</span><span class="p">,</span>
            <span class="s">&#39;D&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_left</span><span class="p">,</span>
            <span class="s">&#39;E&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_next_line</span><span class="p">,</span>
            <span class="s">&#39;F&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_previous_line</span><span class="p">,</span>
            <span class="s">&#39;G&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_horizontal_absolute</span><span class="p">,</span>
            <span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_position</span><span class="p">,</span>
            <span class="s">&#39;L&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_line</span><span class="p">,</span>
            <span class="c">#&#39;M&#39;: self.delete_line, # TODO</span>
            <span class="c">#&#39;b&#39;: self.repeat_last_char, # TODO</span>
            <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csi_device_status_report</span><span class="p">,</span> <span class="c"># Device status report (DSR)</span>
            <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># TODO: Tab clear</span>
            <span class="s">&#39;h&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_expanded_mode</span><span class="p">,</span>
            <span class="s">&#39;l&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_expanded_mode</span><span class="p">,</span>
            <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_position</span><span class="p">,</span>
            <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_position_vertical</span><span class="p">,</span> <span class="c"># Vertical Line Position Absolute (VPA)</span>
            <span class="c">#&#39;e&#39;: self.cursor_position_vertical_relative, # VPR TODO</span>
            <span class="s">&#39;J&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen_from_cursor</span><span class="p">,</span>
            <span class="s">&#39;K&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line_from_cursor</span><span class="p">,</span>
            <span class="s">&#39;S&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_up</span><span class="p">,</span>
            <span class="s">&#39;T&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_down</span><span class="p">,</span>
            <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_cursor_position</span><span class="p">,</span>
            <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_cursor_position</span><span class="p">,</span>
            <span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_rendition</span><span class="p">,</span>
            <span class="s">&#39;n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># &lt;ESC&gt;[6n is the only one I know of (request cursor position)</span>
            <span class="c">#&#39;m&#39;: self.__ignore, # For testing how much CPU we save when not processing CSI</span>
            <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_reset</span><span class="p">,</span> <span class="c"># TODO: &quot;!p&quot; is &quot;Soft terminal reset&quot;.  Also, &quot;Set conformance level&quot; (VT100, VT200, or VT300)</span>
            <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_top_bottom</span><span class="p">,</span> <span class="c"># DECSTBM (used by many apps)</span>
            <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_led_state</span><span class="p">,</span> <span class="c"># Seems a bit silly but you never know</span>
            <span class="s">&#39;P&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_characters</span><span class="p">,</span> <span class="c"># DCH Deletes the specified number of chars</span>
            <span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_erase_characters</span><span class="p">,</span> <span class="c"># ECH Same as DCH but also deletes renditions</span>
            <span class="s">&#39;Z&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_characters</span><span class="p">,</span> <span class="c"># Inserts the specified number of chars</span>
            <span class="s">&#39;@&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_characters</span><span class="p">,</span> <span class="c"># Inserts the specified number of chars</span>
            <span class="c">#&#39;`&#39;: self._char_position_row, # Position cursor (row only)</span>
            <span class="c">#&#39;t&#39;: self.window_manipulation, # TODO</span>
            <span class="c">#&#39;z&#39;: self.locator, # TODO: DECELR &quot;Enable locator reporting&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expanded_modes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># Expanded modes take a True/False argument for set/reset</span>
            <span class="s">&#39;1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">application_mode</span><span class="p">,</span>
            <span class="s">&#39;2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># DECANM and set VT100 mode</span>
            <span class="s">&#39;3&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># 132 Column Mode (DECCOLM)</span>
            <span class="s">&#39;4&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Smooth (Slow) Scroll (DECSCLM)</span>
            <span class="s">&#39;5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Reverse video (might support in future)</span>
            <span class="s">&#39;6&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Origin Mode (DECOM)</span>
            <span class="s">&#39;7&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Wraparound Mode (DECAWM)</span>
            <span class="s">&#39;8&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Auto-repeat Keys (DECARM)</span>
            <span class="s">&#39;9&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send Mouse X &amp; Y on button press (maybe)</span>
            <span class="s">&#39;12&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_receive_mode</span><span class="p">,</span> <span class="c"># SRM</span>
            <span class="s">&#39;18&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Print form feed (DECPFF)</span>
            <span class="s">&#39;19&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set print extent to full screen (DECPEX)</span>
            <span class="s">&#39;25&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_hide_cursor</span><span class="p">,</span>
            <span class="s">&#39;38&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enter Tektronix Mode (DECTEK)</span>
            <span class="s">&#39;41&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># more(1) fix (whatever that is)</span>
            <span class="s">&#39;42&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enable Nation Replacement Character sets (DECNRCM)</span>
            <span class="s">&#39;44&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Turn On Margin Bell</span>
            <span class="s">&#39;45&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Reverse-wraparound Mode</span>
            <span class="s">&#39;46&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Start Logging (Hmmm)</span>
            <span class="s">&#39;47&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternate_screen_buffer</span><span class="p">,</span> <span class="c"># Use Alternate Screen Buffer</span>
            <span class="s">&#39;66&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Application keypad (DECNKM)</span>
            <span class="s">&#39;67&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Backarrow key sends delete (DECBKM)</span>
            <span class="s">&#39;1000&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send Mouse X/Y on button press and release</span>
            <span class="s">&#39;1001&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use Hilite Mouse Tracking</span>
            <span class="s">&#39;1002&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use Cell Motion Mouse Tracking</span>
            <span class="s">&#39;1003&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use All Motion Mouse Tracking</span>
            <span class="s">&#39;1010&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Scroll to bottom on tty output</span>
            <span class="s">&#39;1011&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Scroll to bottom on key press</span>
            <span class="s">&#39;1035&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enable special modifiers for Alt and NumLock keys</span>
            <span class="s">&#39;1036&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send ESC when Meta modifies a key</span>
            <span class="s">&#39;1037&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send DEL from the editing-keypad Delete key</span>
            <span class="s">&#39;1047&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use Alternate Screen Buffer</span>
            <span class="s">&#39;1048&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Save cursor as in DECSC</span>
            <span class="s">&#39;1049&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternate_screen_buffer_cursor</span><span class="p">,</span> <span class="c"># Save cursor as in DECSC and use Alternate Screen Buffer, clearing it first</span>
            <span class="s">&#39;1051&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set Sun function-key mode</span>
            <span class="s">&#39;1052&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set HP function-key mode</span>
            <span class="s">&#39;1060&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set legacy keyboard emulation (X11R6)</span>
            <span class="s">&#39;1061&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set Sun/PC keyboard emulation of VT220 keyboard</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_SCROLL_UP</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CHANGED</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_DSR</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_TITLE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_BELL</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_OPT</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_MODE</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
        <span class="c"># These are for saving self.screen and self.renditions so we can support</span>
        <span class="c"># an &quot;alternate buffer&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_keys</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__linecounter</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.init_screen"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.init_screen">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills self.screen with empty lines of (unicode) spaces using self.cols</span>
<span class="sd">        and self.rows for the dimensions.</span>

<span class="sd">        NOTE: Just because each line starts out with a uniform length does not</span>
<span class="sd">        mean it will stay that way.  Processing of escape sequences is handled</span>
<span class="sd">        when an output function is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c"># Tabstops</span>
        <span class="n">tabs</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c"># Default is every 8 chars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tabs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Fix the first tabstop (which will be -1)</span>
        <span class="c"># Base cursor position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">init_renditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.init_renditions"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.init_renditions">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills self.renditions with lists of None using self.cols and self.rows</span>
<span class="sd">        for the dimenions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">init_scrollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.init_scrollback"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.init_scrollback">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Empties out the scrollback buffers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__reset_linecounter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets self.linecounter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__linecounter</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">terminal_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.terminal_reset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.terminal_reset">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the terminal back to an empty screen with all defaults.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Gate One&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_keys</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_screen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_renditions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;Do nothing&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.resize"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.resize">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resizes the terminal window, adding or removing rows or columns as</span>
<span class="sd">        needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span> <span class="c"># Remove rows from the top</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="n">rows</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rows</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span> <span class="c"># Add rows at the bottom</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">rows</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span>
                <span class="n">renditions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c"># Fix the cursor location:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c"># TODO: Test these to make sure they&#39;re sane in all situations</span>
        <span class="k">if</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span> <span class="c"># Remove cols to the right</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cols</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span> <span class="c"># Add cols to the right</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39; &#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span>

        <span class="c"># Fix the cursor location:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_set_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DECSTBM - Sets self.top_margin and self.bottom_margin using the provided</span>
<span class="sd">        settings in the form of &#39;&lt;top_margin&gt;;&lt;bottom_margin&gt;&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: Used by screen and vi so this needs to work and work well!</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
            <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c"># These are 0-based like self.cursor[XY]</span>
            <span class="k">if</span> <span class="n">bottom</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Reset to defaults (full screen margins)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.get_cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.get_cursor_position">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current cursor positition as a tuple, (row, col)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.set_title"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_title">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets self.title to *title* and executes</span>
<span class="sd">        self.callbacks[self.CALLBACK_TITLE]()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_TITLE</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Got TypeError on CALLBACK_TITLE...&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_TITLE</span><span class="p">]))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c"># TODO: put some logic in these save/restore functions to walk the current</span>
<span class="c"># rendition line to come up with a logical rendition for that exact spot.</span>
    <span class="k">def</span> <span class="nf">save_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.save_cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.save_cursor_position">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the cursor position and current rendition settings to</span>
<span class="sd">        self.saved_cursorX, self.saved_cursorY, and self.saved_rendition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">restore_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.restore_cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.restore_cursor_position">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restores the cursor position and rendition settings from</span>
<span class="sd">        self.saved_cursorX, self.saved_cursorY, and self.saved_rendition (if</span>
<span class="sd">        they&#39;re set).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span>

    <span class="k">def</span> <span class="nf">_dsr_get_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current cursor positition as a DSR response in the form of:</span>
<span class="sd">        &#39;\x1b&lt;self.cursorY&gt;;&lt;self.cursorX&gt;R&#39;.  Also executes CALLBACK_DSR with</span>
<span class="sd">        the same output as the first argument.  Example:</span>

<span class="sd">            self.callbacks[self.CALLBACK_DSR](&#39;\x1b20;123R&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">esc_cursor_pos</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x1b</span><span class="si">%s</span><span class="s">;</span><span class="si">%s</span><span class="s">R&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_DSR</span><span class="p">](</span><span class="n">esc_cursor_pos</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">esc_cursor_pos</span>

    <span class="k">def</span> <span class="nf">_dcs_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles Device Control String sequences.  Still haven&#39;t figured out if</span>
<span class="sd">        these really need to be implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;TODO: Handle this DCS: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_line_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function handles the control sequences that set double and single</span>
<span class="sd">        line heights and widths.  NOTE: Not actually implemented yet!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;TODO: Handle this line height setting: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_G0_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.set_G0_charset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_G0_charset">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the terminal&#39;s G0 (default) charset to the type specified by *char*</span>

<span class="sd">        Here&#39;s the possibilities:</span>
<span class="sd">            0    DEC Special Character and Line Drawing Set</span>
<span class="sd">            A    United Kingdom (UK)</span>
<span class="sd">            B    United States (USASCII)</span>
<span class="sd">            4    Dutch</span>
<span class="sd">            C    Finnish</span>
<span class="sd">            5    Finnish</span>
<span class="sd">            R    French</span>
<span class="sd">            Q    French Canadian</span>
<span class="sd">            K    German</span>
<span class="sd">            Y    Italian</span>
<span class="sd">            E    Norwegian/Danish</span>
<span class="sd">            6    Norwegian/Danish</span>
<span class="sd">            Z    Spanish</span>
<span class="sd">            H    Swedish</span>
<span class="sd">            7    Swedish</span>
<span class="sd">            =    Swiss</span>

<span class="sd">        NOTE: Doesn&#39;t actually do anything other than set the variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">=</span> <span class="n">char</span>

    <span class="k">def</span> <span class="nf">set_G1_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.set_G1_charset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_G1_charset">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the terminal&#39;s G1 (alt) charset to the type specified by *char*</span>

<span class="sd">        Here&#39;s the possibilities:</span>
<span class="sd">            0    DEC Special Character and Line Drawing Set</span>
<span class="sd">            A    United Kingdom (UK)</span>
<span class="sd">            B    United States (USASCII)</span>
<span class="sd">            4    Dutch</span>
<span class="sd">            C    Finnish</span>
<span class="sd">            5    Finnish</span>
<span class="sd">            R    French</span>
<span class="sd">            Q    French Canadian</span>
<span class="sd">            K    German</span>
<span class="sd">            Y    Italian</span>
<span class="sd">            E    Norwegian/Danish</span>
<span class="sd">            6    Norwegian/Danish</span>
<span class="sd">            Z    Spanish</span>
<span class="sd">            H    Swedish</span>
<span class="sd">            7    Swedish</span>
<span class="sd">            =    Swiss</span>

<span class="sd">        NOTE: Doesn&#39;t actually do anything other than set the variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G1_charset</span> <span class="o">=</span> <span class="n">char</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.write"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.write">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write *chars* to the terminal at the current cursor position advancing</span>
<span class="sd">        the cursor as it does so.  If *chars* is not unicode, it will be</span>
<span class="sd">        converted to unicode before being stored in self.screen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Speedups (don&#39;t want dots in loops if they can be avoided)</span>
        <span class="n">specials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span>
        <span class="n">esc_handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_handlers</span>
        <span class="n">csi_handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csi_handlers</span>
        <span class="n">RE_ESC_SEQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_ESC_SEQ</span>
        <span class="n">RE_CSI_ESC_SEQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_CSI_ESC_SEQ</span>
        <span class="n">cursor_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_right</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
            <span class="n">charnum</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">charnum</span> <span class="ow">in</span> <span class="n">specials</span><span class="p">:</span>
                <span class="n">specials</span><span class="p">[</span><span class="n">charnum</span><span class="p">]()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                <span class="c"># Now handle the regular characters and escape sequences</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">:</span> <span class="c"># We&#39;ve got an escape sequence going on...</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">+=</span> <span class="n">char</span>
                        <span class="c"># First try to handle non-CSI ESC sequences (the basics)</span>
                        <span class="n">match_obj</span> <span class="o">=</span> <span class="n">RE_ESC_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
                            <span class="n">seq_type</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># &#39;\x1bA&#39; -&gt; &#39;A&#39;</span>
                            <span class="c"># Call the matching ESC handler</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Single-character sequnces</span>
                                <span class="n">esc_handlers</span><span class="p">[</span><span class="n">seq_type</span><span class="p">]()</span>
                            <span class="k">else</span><span class="p">:</span> <span class="c"># Multi-character stuff like &#39;\x1b)B&#39;</span>
                                <span class="n">esc_handlers</span><span class="p">[</span><span class="n">seq_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">seq_type</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prev_esc_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># All done with this one</span>
                            <span class="k">continue</span>
                        <span class="c"># Next try to handle CSI ESC sequences</span>
                        <span class="n">match_obj</span> <span class="o">=</span> <span class="n">RE_CSI_ESC_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
                            <span class="n">csi_values</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># e.g. &#39;0;1;37&#39;</span>
                            <span class="n">csi_type</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># e.g. &#39;m&#39;</span>
                            <span class="k">if</span> <span class="n">csi_type</span> <span class="o">==</span> <span class="s">&#39;m&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="c"># Call the matching CSI handler</span>
                            <span class="n">csi_handlers</span><span class="p">[</span><span class="n">csi_type</span><span class="p">](</span><span class="n">csi_values</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prev_esc_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c"># No handler for this, try some alternatives</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x1b\\</span><span class="s">&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_osc_handler</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span>
                                <span class="s">&quot;Warning: No ESC sequence handler for </span><span class="si">%s</span><span class="s">&quot;</span>
                                <span class="o">%</span> <span class="sb">`self.esc_buffer`</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">continue</span> <span class="c"># We&#39;re done here</span>
                <span class="c"># TODO: Figure out a way to write characters past the edge of the screen so that users can copy &amp; paste without having newlines in the middle of everything.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span><span class="p">:</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span>
                        <span class="c"># Start a newline but NOTE: Not really the best way to</span>
                        <span class="c"># handle this because it means copying and pasting lines</span>
                        <span class="c"># will end up broken into pieces of size=self.cols</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_newline</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span><span class="p">:</span>
                        <span class="c"># If no rendition was just set on this position empty it</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span>
                            <span class="s">&#39;0&#39;</span><span class="p">][</span><span class="n">charnum</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prev_esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="n">cursor_right</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="c"># Execute our callbacks</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CHANGED</span><span class="p">]()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.flush"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.flush">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Only here to make Terminal compatible with programs that want to use</span>
<span class="sd">        file-like methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">scroll_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.scroll_up"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.scroll_up">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scrolls up the terminal screen by *n* lines (default: 1). The callbacks</span>
<span class="sd">        CALLBACK_CHANGED and CALLBACK_SCROLL_UP are called after scrolling the</span>
<span class="sd">        screen.</span>

<span class="sd">        NOTE: This will only scroll up the region within self.top_margin and</span>
<span class="sd">        self.bottom_margin (if set).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">)</span> <span class="c"># Remove the top line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c"># Add it to the scrollback buffer</span>
            <span class="n">empty_line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="c"># Line full of spaces</span>
            <span class="c"># Add it to the bottom of the window:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">,</span> <span class="n">empty_line</span><span class="p">)</span>
            <span class="c"># Remove top line&#39;s style information</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
            <span class="c"># Insert a new empty rendition as well:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)])</span>
        <span class="c"># Execute our callback indicating lines have been updated</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CHANGED</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Execute our callback to scroll up the screen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_SCROLL_UP</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">scroll_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.scroll_down"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.scroll_down">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scrolls down the terminal screen by *n* lines (default: 1). The</span>
<span class="sd">        callbacks CALLBACK_CHANGED and CALLBACK_SCROLL_DOWN are called after</span>
<span class="sd">        scrolling the screen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span> <span class="c"># Remove the bottom line</span>
            <span class="n">empty_line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="c"># Line full of spaces</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="n">empty_line</span><span class="p">)</span> <span class="c"># Add it to the top</span>
            <span class="c"># Remove bottom line&#39;s style information:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span>
            <span class="c"># Insert a new empty one:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)])</span>
        <span class="c"># Execute our callback indicating lines have been updated</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CHANGED</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Execute our callback to scroll up the screen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_SCROLL_UP</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">insert_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.insert_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.insert_line">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts a line at the current cursor position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span> <span class="c"># Remove the bottom line</span>
        <span class="c"># Remove bottom line&#39;s style information as well:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span>
        <span class="n">empty_line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="c"># Line full of spaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="n">empty_line</span><span class="p">)</span> <span class="c"># Insert at cursor</span>
        <span class="c"># Insert a new empty rendition as well:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_backspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;Execute a backspace (\x08)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor_left</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_horizontal_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute horizontal tab (\x09)&quot;&quot;&quot;</span>
        <span class="n">next_tabstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">tabstop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tabstop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:</span>
                <span class="n">next_tabstop</span> <span class="o">=</span> <span class="n">tabstop</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="n">next_tabstop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_set_tabstop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets a tabstop at the current position of self.cursorX.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tabstop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">&gt;</span> <span class="n">tabstop</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c"># Put them in order :)</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_linefeed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute line feed&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newline</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_next_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Moves cursor down one line&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_reverse_linefeed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_down</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span>

    <span class="k">def</span> <span class="nf">_newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new line to self.screen and sets self.cursorX to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_up</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_line</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_carriage_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute carriage return (set self.cursorX to 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_xon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle XON character (stop ignoring)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_xoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle XOFF character (start ignoring)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_cancel_esc_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancels any escape sequence currently in progress.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_sub_esc_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancels any escape sequence currently in progress and substitutes it</span>
<span class="sd">        with single question mark (?).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_escape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle escape character as well as escape sequences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span>
        <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x1b</span><span class="s">P&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x1b</span><span class="s">]&#39;</span><span class="p">):</span>
            <span class="c"># CSRs and OSCs are special</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x1b</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get rid of whatever&#39;s there since we obviously didn&#39;t know what to</span>
            <span class="c"># do with it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x1b</span><span class="s">&#39;</span>

    <span class="k">def</span> <span class="nf">_string_terminator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the string terminator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: This.</span>
        <span class="c"># NOTE: Might this just call _cancel_esc_sequence?  I need to double-check.</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_osc_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles Operating System Command (OSC) escape sequences which need</span>
<span class="sd">        special care since they are of indeterminiate length and end with either</span>
<span class="sd">        a bell (\x07) or a sequence terminator (\x9c aka ST).  This will usually</span>
<span class="sd">        called from self._bell() to set the title of the terminal (just like an</span>
<span class="sd">        xterm) but it is also possible to be called directly whenever an ST is</span>
<span class="sd">        encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Try the title sequence first</span>
        <span class="n">match_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_TITLE_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="c"># Sets self.title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">return</span>
        <span class="c"># Next try our special optional handler sequence</span>
        <span class="n">match_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_OPT_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__opt_handler</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_bell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle bell character and execute self.CALLBACKS[CALLBACK_BELL]() if we</span>
<span class="sd">        are not in the middle of an escape sequence.  If we *are* in the middle</span>
<span class="sd">        of an escape sequence, call self._osc_handler() since we can be nearly</span>
<span class="sd">        certain that we&#39;re simply terminating an OSC sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: A little explanation is in order: The bell character (\x07) by</span>
        <span class="c">#       itself should play a bell (pretty straighforward).  However, if</span>
        <span class="c">#       the bell character is at the tail end of a particular escape</span>
        <span class="c">#       sequence (string starting with \x1b]0;) this indicates an xterm</span>
        <span class="c">#       title (everything between \x1b]0;...\x07).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">:</span> <span class="c"># We&#39;re not in the middle of an esc sequence</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_BELL</span><span class="p">]()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># We&#39;re (likely) setting a title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x07</span><span class="s">&#39;</span> <span class="c"># Add the bell char so we don&#39;t lose it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_osc_handler</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_device_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns &#39;\x1b[0n&#39; (terminal OK) and executes</span>
<span class="sd">        self.callbacks[self.CALLBACK_DSR](&quot;\x1b[0n&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[0n&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_DSR</span><span class="p">](</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">_csi_device_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns &#39;\x1b[1;2c&#39; (Meaning: I&#39;m a vt220 terminal, version 1.0) and</span>
<span class="sd">        executes self.callbacks[self.CALLBACK_DSR](&quot;\x1b[1;2c&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[1;2c&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_DSR</span><span class="p">](</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">_set_expanded_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accepts &quot;standard mode&quot; settings.  Typically &#39;\x1b[?25h&#39; to hide cursor.</span>

<span class="sd">        Notes on modes::</span>
<span class="sd">            &#39;?1h&#39; - Application Cursor Keys</span>
<span class="sd">            &#39;?12h&#39; - Local echo (SRM or Send Receive Mode)</span>
<span class="sd">            &#39;?25h&#39; - Hide cursor</span>
<span class="sd">            &#39;?1049h&#39; - Save cursor and screen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: Add support for the following:</span>
        <span class="c"># * 3: 132 column mode (might be &quot;or greater&quot;)</span>
        <span class="c"># * 4: Smooth scroll (for animations and also makes things less choppy)</span>
        <span class="c"># * 5: Reverse video (should be easy: just need some extra CSS)</span>
        <span class="c"># * 6: Origin mode</span>
        <span class="c"># * 7: Wraparound mode</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">setting</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># Don&#39;t need the ?</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expanded_modes</span><span class="p">[</span><span class="n">setting</span><span class="p">](</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span> <span class="c"># Unsupported expanded mode</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_MODE</span><span class="p">](</span><span class="n">setting</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_reset_expanded_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accepts &quot;standard mode&quot; settings.  Typically &#39;\x1b[?25l&#39; to show cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">setting</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># Don&#39;t need the ?</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expanded_modes</span><span class="p">[</span><span class="n">setting</span><span class="p">](</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span> <span class="c"># Unsupported expanded mode</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_MODE</span><span class="p">](</span><span class="n">setting</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">application_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.application_mode"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.application_mode">[docs]</a>        <span class="sd">&quot;&quot;&quot;self.application_keys = *boolean*&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_keys</span> <span class="o">=</span> <span class="n">boolean</span>

    <span class="k">def</span> <span class="nf">alternate_screen_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.alternate_screen_buffer"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.alternate_screen_buffer">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If *alt* is True, copy the current screen and renditions to</span>
<span class="sd">        self.alt_screen and self.alt_renditions then re-init self.screen and</span>
<span class="sd">        self.renditions.</span>
<span class="sd">        If *alt* is False, restore the saved screen buffer and renditions then</span>
<span class="sd">        nullify self.alt_screen and self.alt_renditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
            <span class="c"># Save the existing screen and renditions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">)</span>
            <span class="c"># Make a fresh one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Restore the screen</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span>
            <span class="c"># Empty out the alternate buffer (to save memory)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">alternate_screen_buffer_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.alternate_screen_buffer_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.alternate_screen_buffer_cursor">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as self.alternate_screen_buffer but saves/restores the cursor</span>
<span class="sd">        location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alternate_screen_buffer</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">show_hide_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.show_hide_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.show_hide_cursor">[docs]</a>        <span class="sd">&quot;&quot;&quot;self.show_cursor = boolean&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span> <span class="o">=</span> <span class="n">boolean</span>

    <span class="k">def</span> <span class="nf">send_receive_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onoff</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.send_receive_mode"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.send_receive_mode">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns on or off local echo dependong on the value of *onoff*</span>

<span class="sd">        self.local_echo = *onoff*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">onoff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">insert_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.insert_characters"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.insert_characters">[docs]</a>        <span class="sd">&quot;&quot;&quot;Inserts the specified number of characters at the cursor position&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c"># Take one down, pass it around</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">,</span> <span class="s">u&#39; &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.delete_characters"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.delete_characters">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DCH - Deletes (to the left) the specified number of characters at the</span>
<span class="sd">        cursor position.  As characters are deleted, the remaining characters</span>
<span class="sd">        between the cursor and right margin move to the left. Character</span>
<span class="sd">        attributes (renditions) move with the characters.  The terminal adds</span>
<span class="sd">        blank spaces with no visual character attributes at the right margin.</span>
<span class="sd">        DCH has no effect outside the scrolling margins.</span>

<span class="sd">        NOTE: Deletes renditions too.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># e.g. n == &#39;&#39;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c"># At edge of screen, ignore</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_erase_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Erases (to the right) the specified number of characters at the cursor</span>
<span class="sd">        position.  NOTE: Deletes renditions too.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># e.g. n == &#39;&#39;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39; &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">cursor_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.cursor_left"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_left">[docs]</a>        <span class="sd">&quot;&quot;&quot;ESCnD CUB (Cursor Back)&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">cursor_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_right"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_right">[docs]</a>        <span class="sd">&quot;&quot;&quot;ESCnC CUF (Cursor Forward)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">cursor_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_up"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_up">[docs]</a>        <span class="sd">&quot;&quot;&quot;ESCnA CUU (Cursor Up)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cursor_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_down"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_down">[docs]</a>        <span class="sd">&quot;&quot;&quot;ESCnB CUD (Cursor Down)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cursor_next_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_next_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_next_line">[docs]</a>        <span class="sd">&quot;&quot;&quot;ESCnE CNL (Cursor Next Line)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cursor_previous_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_previous_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_previous_line">[docs]</a>        <span class="sd">&quot;&quot;&quot;ESCnF CPL (Cursor Previous Line)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cursor_horizontal_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_horizontal_absolute"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_horizontal_absolute">[docs]</a>        <span class="sd">&quot;&quot;&quot;ESCnG CHA (Cursor Horizontal Absolute)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="c"># -1 because cols is 0-based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_position">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ESCnH CUP (Cursor Position).  Move the cursor to the given coordinates.</span>

<span class="sd">        *coordinates*: Should be something like, &#39;row;col&#39; (1-based) but,</span>
<span class="sd">        &#39;row&#39;, &#39;row;&#39;, and &#39;;col&#39; are also valid (assumes 1 on missing value).</span>

<span class="sd">        If coordinates is &#39;&#39;, the cursor will be moved to the top left (1;1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: Since this is 1-based we have to subtract 1 from everything to</span>
        <span class="c">#       match how we store these values internally.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coordinates</span><span class="p">:</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="s">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">:</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">coordinates</span>
            <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># These ensure a positive integer while reducing row and col by 1:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="n">row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cursor_position_vertical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.cursor_position_vertical"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_position_vertical">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vertical Line Position Absolute (VPA) - Moves the cursor to given line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">clear_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_screen"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen.  Also used to emulate a terminal reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_screen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_renditions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">clear_screen_from_cursor_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_screen_from_cursor_down"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen_from_cursor_down">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor down (Esc[J or Esc[0J).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">clear_screen_from_cursor_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_screen_from_cursor_up"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen_from_cursor_up">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor up (Esc[1J).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">clear_screen_from_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_screen_from_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen_from_cursor">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CSI*n*J ED (Erase Data).  This escape sequence uses the following rules::</span>

<span class="sd">            Esc[J   Clear screen from cursor down   ED0</span>
<span class="sd">            Esc[0J  Clear screen from cursor down   ED0</span>
<span class="sd">            Esc[1J  Clear screen from cursor up     ED1</span>
<span class="sd">            Esc[2J  Clear entire screen             ED2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># Esc[J</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">clear_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen_from_cursor_down</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen_from_cursor_up</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clear_types</span><span class="p">[</span><span class="n">n</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error: Unsupported number for escape sequence J&quot;</span><span class="p">)</span>
        <span class="c"># Execute our callbacks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CHANGED</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">clear_line_from_cursor_right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_line_from_cursor_right"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line_from_cursor_right">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor right (Esc[K or Esc[0K).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]]</span>
        <span class="c"># NOTE: We have to check if a rendition was just set for this cursor</span>
        <span class="c">#       position since \x1b[K is only supposed to clear renditions that</span>
        <span class="c">#       were set prior to the cursor being placed at its current</span>
        <span class="c">#       position (which is odd--and I can&#39;t find any documentation that</span>
        <span class="c">#       says that&#39;s how it is supposed to work but it seems to be the</span>
        <span class="c">#       case in real-world testing).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_esc_buffer</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;m&#39;</span><span class="p">):</span> <span class="c"># Was a rendition, preserve it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Reset the cursor position&#39;s rendition to the end of the line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]]</span>

    <span class="k">def</span> <span class="nf">clear_line_from_cursor_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_line_from_cursor_left"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line_from_cursor_left">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor left (Esc[1K).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span>
        <span class="n">saved_renditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">saved_renditions</span>

    <span class="k">def</span> <span class="nf">clear_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the entire line (Esc[2K).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">clear_line_from_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.clear_line_from_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line_from_cursor">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CSI*n*K EL (Erase in Line).  This escape sequence uses the following</span>
<span class="sd">        rules::</span>

<span class="sd">            Esc[K   Clear screen from cursor right  EL0</span>
<span class="sd">            Esc[0K  Clear screen from cursor right  EL0</span>
<span class="sd">            Esc[1K  Clear screen from cursor left   EL1</span>
<span class="sd">            Esc[2K  Clear entire line               ED2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># Esc[J</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">clear_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line_from_cursor_right</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line_from_cursor_left</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clear_types</span><span class="p">[</span><span class="n">n</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error: Unsupported number for CSI escape sequence K&quot;</span><span class="p">)</span>
        <span class="c"># Execute our callbacks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CHANGED</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">set_led_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.set_led_state"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_led_state">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the values the dict, self.leds depending on *n* using the following</span>
<span class="sd">        rules:</span>

<span class="sd">            Esc[0q  Turn off all four leds  DECLL0</span>
<span class="sd">            Esc[1q  Turn on LED #1          DECLL1</span>
<span class="sd">            Esc[2q  Turn on LED #2          DECLL2</span>
<span class="sd">            Esc[3q  Turn on LED #3          DECLL3</span>
<span class="sd">            Esc[4q  Turn on LED #4          DECLL4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__reduce_renditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renditions</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a list, *renditions*, and reduces it to its logical equivalent (as</span>
<span class="sd">        far as renditions go).  Example:</span>

<span class="sd">            [0, 32, 0, 34, 0, 32]</span>

<span class="sd">        Would become:</span>

<span class="sd">            [0, 32]</span>

<span class="sd">        Other Examples:</span>

<span class="sd">            [0, 1, 36, 36] -&gt; [0, 1, 36]</span>
<span class="sd">            [0, 30, 42, 30, 42] -&gt; [0, 30, 42]</span>
<span class="sd">            [36, 32, 44, 42] -&gt; [32, 42]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_renditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">foreground</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">background</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rend</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">renditions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">29</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_renditions</span><span class="p">:</span>
                    <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rend</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rend</span> <span class="o">&gt;</span> <span class="mi">29</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">foreground</span> <span class="o">=</span> <span class="n">rend</span>
            <span class="k">elif</span> <span class="n">rend</span> <span class="o">&gt;</span> <span class="mi">39</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">background</span> <span class="o">=</span> <span class="n">rend</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">foreground</span><span class="p">:</span>
            <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">foreground</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
            <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_renditions</span>

    <span class="k">def</span> <span class="nf">_set_rendition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets self.renditions[self.cursorY][self.cursorX] equal to n.split(&#39;;&#39;).</span>
<span class="sd">        *n* is expected to be a string of ECMA-48 rendition numbers separated by</span>
<span class="sd">        semicolons.  Example:</span>
<span class="sd">            &#39;0;1;31&#39;</span>
<span class="sd">        ...will result in:</span>
<span class="sd">            [0, 1, 31]</span>

<span class="sd">        Note that the numbers were converted to integers and the order was</span>
<span class="sd">        preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: Make this whole thing faster (or prove it isn&#39;t possible).</span>
        <span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="k">if</span> <span class="n">cursorX</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span> <span class="c"># We&#39;re at the end of the row</span>
            <span class="k">return</span>
            <span class="c">#cursorY += 1 # Set the rendition for the next line</span>
            <span class="c">#cursorX = 0</span>
        <span class="k">if</span> <span class="n">cursorY</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># Don&#39;t bother setting renditions past the bottom</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># or \x1b[m (reset)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">][</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="c"># No need for further processing; save some CPU</span>
        <span class="c"># Convert the string (e.g. &#39;0;1;32&#39;) to a list (e.g. [0,1,32]</span>
        <span class="n">new_renditions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">][</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_renditions</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># Nothing left to do</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">][</span><span class="n">cursorX</span><span class="p">]:</span>
            <span class="c"># Existing rendition for this spot... Tack it on the end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">][</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_renditions</span>
            <span class="c"># Remove duplicates and unnecessary renditions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">][</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reduce_renditions</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">][</span><span class="n">cursorX</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">][</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reduce_renditions</span><span class="p">(</span><span class="n">new_renditions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__opt_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optional special escape sequence handler for sequences matching</span>
<span class="sd">        RE_OPT_SEQ.  If self.CALLBACK_OPT is defined it will be called like so:</span>
<span class="sd">            self.CALLBACKS[self.CALLBACK_OPT](chars)</span>

<span class="sd">        Applications can use this escape sequence to define whatever special</span>
<span class="sd">        handlers they like.  It works like this: If an escape sequence is</span>
<span class="sd">        encountered matching RE_OPT_SEQ this method will be called with the</span>
<span class="sd">        inbetween *chars* (e.g. \x1b]_;&lt;chars&gt;\x07) as the argument.</span>

<span class="sd">        Applications can then do what they wish with *chars*.</span>

<span class="sd">        NOTE: I added this functionality so that plugin authors would have a</span>
<span class="sd">        mechanism to communicate with terminal applications.  See the SSH plugin</span>
<span class="sd">        for an example of how this can be done (there&#39;s channels of</span>
<span class="sd">        communication amongst ssh_connect.py, ssh.js, and ssh.py).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALLBACK_OPT</span><span class="p">](</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># High likelyhood that nothing is defined.  No biggie.</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__spanify_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">renditions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates over *line* and *renditions*, applying HTML markup (spans)</span>
<span class="sd">        where appropriate and returns a single line as the result. It also marks</span>
<span class="sd">        the cursor position via a &lt;span&gt; tag at the appropriate location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">linecount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__linecounter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">outline</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">charcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rendition_classes</span> <span class="o">=</span> <span class="n">RENDITION_CLASSES</span>
        <span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="n">classcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">spancount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">foregrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;f0&#39;</span><span class="p">,</span><span class="s">&#39;f1&#39;</span><span class="p">,</span><span class="s">&#39;f2&#39;</span><span class="p">,</span><span class="s">&#39;f3&#39;</span><span class="p">,</span><span class="s">&#39;f4&#39;</span><span class="p">,</span><span class="s">&#39;f5&#39;</span><span class="p">,</span><span class="s">&#39;f6&#39;</span><span class="p">,</span><span class="s">&#39;f7&#39;</span><span class="p">)</span>
        <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;b0&#39;</span><span class="p">,</span><span class="s">&#39;b1&#39;</span><span class="p">,</span><span class="s">&#39;b2&#39;</span><span class="p">,</span><span class="s">&#39;b3&#39;</span><span class="p">,</span><span class="s">&#39;b4&#39;</span><span class="p">,</span><span class="s">&#39;b5&#39;</span><span class="p">,</span><span class="s">&#39;b6&#39;</span><span class="p">,</span><span class="s">&#39;b7&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">rendition</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">renditions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="s">&quot;&lt;&gt;&quot;</span><span class="p">:</span> <span class="c"># Have to convert lt/gt to HTML entities</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;gt;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rendition</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="n">imap</span><span class="p">(</span><span class="n">rendition_classes</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">rendition</span><span class="p">)</span>
                <span class="n">same_as_before</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_classes</span><span class="p">:</span>
                        <span class="c"># Something changed...  Start a new span</span>
                        <span class="n">same_as_before</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">if</span> <span class="n">spancount</span><span class="p">:</span>
                            <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
                            <span class="n">spancount</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="s">&#39;reset&#39;</span> <span class="ow">in</span> <span class="n">_class</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">_class</span> <span class="o">==</span> <span class="s">&#39;reset&#39;</span><span class="p">:</span>
                                <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">reset_class</span> <span class="o">=</span> <span class="n">_class</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;reset&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;foreground&#39;</span><span class="p">:</span>
                                    <span class="c"># Remove any foreground classes</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="n">foregrounds</span>
                                    <span class="p">]</span>
                                <span class="k">elif</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;background&#39;</span><span class="p">:</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="n">backgrounds</span>
                                    <span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">current_classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reset_class</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="c"># Trying to reset something that was</span>
                                        <span class="c"># never set.  Ignore</span>
                                        <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">foregrounds</span><span class="p">:</span>
                                <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="n">foregrounds</span>
                                <span class="p">]</span>
                            <span class="k">elif</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">backgrounds</span><span class="p">:</span>
                                <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="n">backgrounds</span>
                                <span class="p">]</span>
                            <span class="n">current_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_class</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_classes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">same_as_before</span><span class="p">:</span>
                    <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;&lt;span class=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span>
                    <span class="n">spancount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">linecount</span> <span class="o">==</span> <span class="n">cursorY</span> <span class="ow">and</span> <span class="n">charcount</span> <span class="o">==</span> <span class="n">cursorX</span><span class="p">:</span> <span class="c"># Cursor position</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span><span class="p">:</span>
                    <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;&lt;span class=&quot;cursor&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/span&gt;&#39;</span> <span class="o">%</span> <span class="n">char</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outline</span> <span class="o">+=</span> <span class="n">char</span>
                <span class="c"># Use the simpler self.__spanify_line_no_cursor as a speedup:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_line_no_cursor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outline</span> <span class="o">+=</span> <span class="n">char</span>
            <span class="n">charcount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">whatever</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">spancount</span><span class="p">):</span>
            <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
        <span class="k">return</span> <span class="n">outline</span>

    <span class="k">def</span> <span class="nf">__spanify_line_no_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">renditions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates over *lines* and *renditions*, applying HTML markup (spans)</span>
<span class="sd">        where appropriate and returns a single line as the result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outline</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">classcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">charcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rendition_classes</span> <span class="o">=</span> <span class="n">RENDITION_CLASSES</span>
        <span class="n">spancount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">foregrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;f0&#39;</span><span class="p">,</span><span class="s">&#39;f1&#39;</span><span class="p">,</span><span class="s">&#39;f2&#39;</span><span class="p">,</span><span class="s">&#39;f3&#39;</span><span class="p">,</span><span class="s">&#39;f4&#39;</span><span class="p">,</span><span class="s">&#39;f5&#39;</span><span class="p">,</span><span class="s">&#39;f6&#39;</span><span class="p">,</span><span class="s">&#39;f7&#39;</span><span class="p">)</span>
        <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;b0&#39;</span><span class="p">,</span><span class="s">&#39;b1&#39;</span><span class="p">,</span><span class="s">&#39;b2&#39;</span><span class="p">,</span><span class="s">&#39;b3&#39;</span><span class="p">,</span><span class="s">&#39;b4&#39;</span><span class="p">,</span><span class="s">&#39;b5&#39;</span><span class="p">,</span><span class="s">&#39;b6&#39;</span><span class="p">,</span><span class="s">&#39;b7&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">rendition</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">renditions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="s">&quot;&lt;&gt;&quot;</span><span class="p">:</span> <span class="c"># Have to escape lt/gt</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;gt;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rendition</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="n">imap</span><span class="p">(</span><span class="n">rendition_classes</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">rendition</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_classes</span><span class="p">:</span>
                        <span class="c"># Something changed...  Start a new span</span>
                        <span class="k">if</span> <span class="n">spancount</span><span class="p">:</span>
                            <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
                            <span class="n">spancount</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="s">&#39;reset&#39;</span> <span class="ow">in</span> <span class="n">_class</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">_class</span> <span class="o">==</span> <span class="s">&#39;reset&#39;</span><span class="p">:</span>
                                <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">reset_class</span> <span class="o">=</span> <span class="n">_class</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;reset&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;foreground&#39;</span><span class="p">:</span>
                                    <span class="c"># Remove any foreground classes</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="n">foregrounds</span>
                                    <span class="p">]</span>
                                <span class="k">elif</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;background&#39;</span><span class="p">:</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                     <span class="n">backgrounds</span>
                                    <span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">current_classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reset_class</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="c"># Trying to reset something that was</span>
                                        <span class="c"># never set.  Ignore</span>
                                        <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">foregrounds</span><span class="p">:</span>
                                <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="n">foregrounds</span>
                                <span class="p">]</span>
                            <span class="k">elif</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">foregrounds</span><span class="p">:</span>
                                <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                 <span class="n">foregrounds</span>
                                <span class="p">]</span>
                            <span class="n">current_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_class</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_classes</span><span class="p">:</span>
                    <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;&lt;span class=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span>
                    <span class="n">spancount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">outline</span> <span class="o">+=</span> <span class="n">char</span>
            <span class="n">charcount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">whatever</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">spancount</span><span class="p">):</span>
            <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
        <span class="k">return</span> <span class="n">outline</span>

    <span class="k">def</span> <span class="nf">dump_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="Terminal.dump_html"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump_html">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the terminal screen as a list of HTML-formatted lines.</span>

<span class="sd">        Note: This places &lt;span class=&quot;cursor&quot;&gt;(current character)&lt;/span&gt; around</span>
<span class="sd">        the cursor location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__spanify_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reset_linecounter</span><span class="p">()</span>
        <span class="c"># Reset self.__spanify_line back to default:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__temp</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__temp</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># No cursor yet</span>
        <span class="n">scrollback</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">:</span>
            <span class="c"># Process the scrollback buffer too</span>
            <span class="n">scrollback</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_line_no_cursor</span><span class="p">,</span> <span class="c"># Slightly faster</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span>
            <span class="p">)</span>
        <span class="c"># Empty the scrollback buffer:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reset_linecounter</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scrollback</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_plain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.dump_plain"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump_plain">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the screen and the scrollback buffer as-is then empties the</span>
<span class="sd">        scrollback buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span>
        <span class="n">scrollback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span>
        <span class="c"># Empty the scrollback buffer:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scrollback</span><span class="p">,</span> <span class="n">screen</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.dump_components"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump_components">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the screen and renditions as-is, the scrollback buffer as HTML,</span>
<span class="sd">        and the current cursor coordinates.  Also, empties the scrollback buffer</span>

<span class="sd">        NOTE: Was used in some performance-related experiments but might be</span>
<span class="sd">        useful for other patterns in the future so I&#39;ve left it here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">tounicode</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">]</span>
        <span class="n">scrollback</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">:</span>
            <span class="c"># Process the scrollback buffer into HTML</span>
            <span class="n">scrollback</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_line_no_cursor</span><span class="p">,</span> <span class="c"># Slightly faster (no cursor logic)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span>
            <span class="p">)</span>
        <span class="c"># Empty the scrollback buffer:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scrollback</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Terminal.dump"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns self.screen as a list of strings with no formatting.</span>
<span class="sd">        No scrollback buffer.  No renditions.</span>

<span class="sd">        NOTE: Does not empty the scrollback buffer.  Primarily used to get a</span>
<span class="sd">        quick glance of what is being displayed (when debugging).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Liftoff Software Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.8.
    </div>
  </body>
</html>